# Finance Agent æ•°æ®åº“è®¾è®¡è¯´æ˜

> **ç‰ˆæœ¬**ï¼š2.0 (åŸºäºå®é™…æ•°æ®ä¼˜åŒ–)  
> **æœ€åæ›´æ–°**ï¼š2025-11-27

---

## ğŸ“Š è®¾è®¡æ¦‚è¿°

### æ ¸å¿ƒè®¾è®¡æ€è·¯ï¼š**æ··åˆå­˜å‚¨ç­–ç•¥**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     reports è¡¨ï¼ˆä¸»è¡¨ï¼‰                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ æ ¸å¿ƒå…ƒæ•°æ®  â”‚  â”‚ æå–å­—æ®µ    â”‚  â”‚  å®Œæ•´ JSON å­˜å‚¨   â”‚  â”‚
â”‚  â”‚ - title     â”‚  â”‚ - action    â”‚  â”‚  analysis_json    â”‚  â”‚
â”‚  â”‚ - category  â”‚  â”‚ - sentiment â”‚  â”‚  (æ‰€æœ‰ç»†èŠ‚)       â”‚  â”‚
â”‚  â”‚ - date      â”‚  â”‚ - scores    â”‚  â”‚                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â”œâ”€â”€â”€â”€â”€â”€â”
                           â†“      â†“
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚ reports_fts (FTS5) â”‚  â”‚ åŸå§‹æ–‡æœ¬ content  â”‚
           â”‚  å…¨æ–‡æœç´¢ç´¢å¼•      â”‚  â”‚  (3000+ å­—)       â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ ä¸ºä»€ä¹ˆé‡‡ç”¨è¿™ç§è®¾è®¡ï¼Ÿ

### é—®é¢˜ 1ï¼šä¸ºä»€ä¹ˆä¸æŠŠ JSON å…¨éƒ¨å±•å¼€æˆç‹¬ç«‹è¡¨ï¼Ÿ

#### âŒ å®Œå…¨è§„èŒƒåŒ–çš„æ–¹æ¡ˆï¼ˆä¸æ¨èï¼‰
```sql
-- éœ€è¦åˆ›å»º 10+ å¼ è¡¨
reports
â”œâ”€â”€ investment_targets (æ¨èæ ‡çš„è¡¨)
â”œâ”€â”€ cautious_targets (è°¨æ…æ ‡çš„è¡¨)
â”œâ”€â”€ risk_warnings (é£é™©é¢„è­¦è¡¨)
â”œâ”€â”€ timeline_events (æ—¶é—´çº¿äº‹ä»¶è¡¨)
â”œâ”€â”€ key_data (å…³é”®æ•°æ®è¡¨)
â””â”€â”€ ...
```

**ç¼ºç‚¹**ï¼š
- ğŸ”´ æŸ¥è¯¢å¤æ‚ï¼ˆéœ€è¦å¤šæ¬¡ JOINï¼‰
- ğŸ”´ æ’å…¥æ•°æ®ç¹çï¼ˆäº‹åŠ¡å¤æ‚ï¼‰
- ğŸ”´ JSON ç»“æ„å˜åŒ–æ—¶éœ€è¦ä¿®æ”¹è¡¨ç»“æ„
- ğŸ”´ è¿‡åº¦è®¾è®¡ï¼ˆMVP ä¸éœ€è¦ï¼‰

#### âœ… æ··åˆå­˜å‚¨æ–¹æ¡ˆï¼ˆæ¨èï¼‰
```sql
-- åªéœ€è¦ 3 å¼ æ ¸å¿ƒè¡¨
reports (ä¸»è¡¨ï¼Œå­˜å‚¨å®Œæ•´ JSON)
reports_fts (FTS5 æœç´¢)
ui_states (ç³»ç»Ÿè¡¨)
```

**ä¼˜ç‚¹**ï¼š
- âœ… **çµæ´»æ€§**ï¼šJSON ç»“æ„å˜åŒ–ä¸å½±å“æ•°æ®åº“
- âœ… **ç®€å•æ€§**ï¼šæ’å…¥ä¸€æ¡è®°å½•å³å¯
- âœ… **æ€§èƒ½**ï¼šé«˜é¢‘æŸ¥è¯¢å­—æ®µå·²æå–åˆ°åˆ—ï¼ˆaction, scores, sentimentï¼‰
- âœ… **å®Œæ•´æ€§**ï¼šanalysis_json ä¿ç•™æ‰€æœ‰ç»†èŠ‚

---

### é—®é¢˜ 2ï¼šä¸ºä»€ä¹ˆè¦æå–éƒ¨åˆ†å­—æ®µåˆ°åˆ—ï¼Ÿ

**å®é™…æŸ¥è¯¢éœ€æ±‚åˆ†æ**ï¼š

#### é«˜é¢‘æŸ¥è¯¢ï¼ˆéœ€è¦ç‹¬ç«‹åˆ—ï¼‰
```sql
-- è¿™äº›æŸ¥è¯¢å¾ˆå¸¸è§ï¼Œéœ€è¦ç´¢å¼•æ”¯æŒ
SELECT * FROM reports WHERE action = 'buy';
SELECT * FROM reports WHERE importance_score >= 8;
SELECT * FROM reports WHERE date_published > '2025-11';
```

#### ä½é¢‘æŸ¥è¯¢ï¼ˆJSON å­˜å‚¨å³å¯ï¼‰
```python
# è¿™äº›æŸ¥è¯¢ä¸é¢‘ç¹ï¼Œå¯ä»¥åœ¨åº”ç”¨å±‚å¤„ç†
report = db.get_report(report_id)
analysis = json.loads(report.analysis_json)
timeline_events = analysis['timeline_events']  # Python è§£æ
investment_targets = analysis['investment_targets']['recommended']
```

**è®¾è®¡åŸåˆ™**ï¼š
- âœ… **80/20 åŸåˆ™**ï¼š20% çš„å­—æ®µæ»¡è¶³ 80% çš„æŸ¥è¯¢
- âœ… **æå–å­—æ®µ**ï¼šaction, scores, sentiment, date_published, category
- âœ… **JSON å­˜å‚¨**ï¼štimeline_events, investment_targets, risk_warnings

---

## ğŸ“‹ è¡¨ç»“æ„è®¾è®¡

### 1. **reports è¡¨**ï¼ˆä¸»è¡¨ï¼‰

```sql
CREATE TABLE reports (
  -- æ ¸å¿ƒå…ƒæ•°æ®ï¼ˆé«˜é¢‘æŸ¥è¯¢ï¼‰
  report_id TEXT UNIQUE NOT NULL,
  title TEXT NOT NULL,
  category TEXT,
  date_published TEXT NOT NULL,
  
  -- æå–çš„å…³é”®å­—æ®µï¼ˆç”¨äºç­›é€‰å’Œæ’åºï¼‰
  action TEXT,                    -- 'buy' | 'sell' | 'hold' | 'watch'
  sentiment TEXT,                 -- 'positive' | 'neutral' | 'negative'
  importance_score INTEGER,
  urgency_score INTEGER,
  reliability_score INTEGER,
  
  -- åŸå§‹æ–‡æœ¬ï¼ˆç”¨äºå…¨æ–‡æœç´¢ï¼‰
  content TEXT,
  
  -- å®Œæ•´ JSON æ•°æ®ï¼ˆä¿ç•™æ‰€æœ‰ç»†èŠ‚ï¼‰
  analysis_json TEXT              -- å®Œæ•´çš„ç»“æ„åŒ–æ•°æ®
);
```

### 2. **reports_fts è¡¨**ï¼ˆFTS5 å…¨æ–‡æœç´¢ï¼‰

```sql
CREATE VIRTUAL TABLE reports_fts USING fts5(
  report_id UNINDEXED,
  title,
  content,                        -- ç´¢å¼• 3000+ å­—çš„åŸæ–‡
  summary_one_sentence,
  tokenize = 'porter unicode61'   -- ä¸­è‹±æ–‡åˆ†è¯
);
```

### 3. **ui_states è¡¨**ï¼ˆç³»ç»Ÿæ ¸å¿ƒè¡¨ï¼‰

ä¸ Email Agent å®Œå…¨ä¸€è‡´ï¼Œç”¨äºå­˜å‚¨åŠ¨æ€ UI ç»„ä»¶çŠ¶æ€ã€‚

---

## ğŸ” å…¸å‹æŸ¥è¯¢åœºæ™¯

### åœºæ™¯ 1ï¼šå…¨æ–‡æœç´¢ + ç­›é€‰

```sql
-- æŸ¥æ‰¾åŒ…å«"é»„é‡‘"ä¸”é‡è¦æ€§ >= 8 çš„æŠ¥å‘Š
SELECT 
  r.title,
  r.date_published,
  r.importance_score,
  r.summary_one_sentence
FROM reports r
JOIN reports_fts fts ON r.report_id = fts.report_id
WHERE reports_fts MATCH 'é»„é‡‘'
  AND r.importance_score >= 8
ORDER BY rank
LIMIT 10;
```

### åœºæ™¯ 2ï¼šæŒ‰æŠ•èµ„å»ºè®®ç­›é€‰

```sql
-- æŸ¥æ‰¾æ‰€æœ‰å»ºè®®"è§‚æœ›"çš„æŠ¥å‘Š
SELECT 
  title,
  action,
  target_allocation,
  timing,
  confidence_level
FROM reports
WHERE action = 'watch'
ORDER BY date_published DESC;
```

### åœºæ™¯ 3ï¼šè·å–å®Œæ•´åˆ†ææ•°æ®

```python
# Python ä»£ç ç¤ºä¾‹
report = db.query("SELECT analysis_json FROM reports WHERE report_id = ?", [report_id])
analysis = json.loads(report['analysis_json'])

# è®¿é—®æŠ•èµ„æ ‡çš„
recommended_targets = analysis['investment_targets']['recommended']
for target in recommended_targets:
    print(f"{target['name']}: {target['reason']}")

# è®¿é—®é£é™©é¢„è­¦
risk_warnings = analysis['risk_warnings']
for risk in risk_warnings:
    print(f"{risk['risk_type']}: {risk['description']}")
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### ç´¢å¼•ç­–ç•¥

```sql
-- æ ¸å¿ƒç´¢å¼•ï¼ˆæ”¯æŒé«˜é¢‘æŸ¥è¯¢ï¼‰
CREATE INDEX idx_reports_date ON reports(date_published DESC);
CREATE INDEX idx_reports_category ON reports(category);
CREATE INDEX idx_reports_action ON reports(action);
CREATE INDEX idx_reports_importance ON reports(importance_score DESC);

-- å¤åˆç´¢å¼•ï¼ˆæ”¯æŒç»„åˆæŸ¥è¯¢ï¼‰
CREATE INDEX idx_reports_category_date ON reports(category, date_published DESC);
CREATE INDEX idx_reports_action_date ON reports(action, date_published DESC);
```

### æ€§èƒ½é¢„ä¼°

| æ•°æ®é‡ | FTS5 æœç´¢é€Ÿåº¦ | JSON è§£æé€Ÿåº¦ | æ•°æ®åº“æ–‡ä»¶å¤§å° |
|--------|--------------|--------------|---------------|
| 100 ä»½æŠ¥å‘Š | < 10ms | < 1ms | ~10MB |
| 1,000 ä»½æŠ¥å‘Š | < 20ms | < 1ms | ~100MB |
| 10,000 ä»½æŠ¥å‘Š | < 50ms | < 1ms | ~1GB |

---

## ğŸ†š ä¸ Email Agent çš„å¯¹æ¯”

| ç»´åº¦ | Email Agent | Finance Agent |
|------|-------------|---------------|
| **ä¸»è¡¨** | `emails` | `reports` |
| **æ ¸å¿ƒå­—æ®µ** | subject, bodyText | title, content |
| **åˆ†ç±»æ–¹å¼** | folder, labels | category, sentiment, action |
| **ç»“æ„åŒ–æ•°æ®** | ç®€å•å…ƒæ•°æ® | **å¤æ‚ JSON**ï¼ˆæŠ•èµ„å»ºè®®ã€é£é™©é¢„è­¦ï¼‰ |
| **FTS5** | âœ… emails_fts | âœ… reports_fts |
| **ç³»ç»Ÿè¡¨** | ui_states, component_instances | âœ… å®Œå…¨ç›¸åŒ |
| **ç´¢å¼•ç­–ç•¥** | date, folder, from | date, category, action, scores |

**ç»“è®º**ï¼šæ¶æ„ 95% ç›¸ä¼¼ï¼Œåªéœ€è°ƒæ•´ä¸šåŠ¡å­—æ®µï¼

---

## ğŸš€ å®ç°å»ºè®®

### MVP é˜¶æ®µï¼ˆWeek 1-2ï¼‰

1. âœ… **åªå®ç° 3 å¼ æ ¸å¿ƒè¡¨**
   - reports
   - reports_fts
   - ui_states

2. âœ… **æ ¸å¿ƒåŠŸèƒ½**
   - æ’å…¥æŠ¥å‘Šï¼ˆæ–‡æœ¬ + JSONï¼‰
   - å…¨æ–‡æœç´¢
   - æŒ‰åˆ†ç±»/æ—¥æœŸæŸ¥è¯¢

3. â­ï¸ **æš‚ä¸å®ç°**
   - ç‹¬ç«‹çš„ investment_targets è¡¨
   - ç‹¬ç«‹çš„ risk_warnings è¡¨
   - å¤æ‚çš„ç»Ÿè®¡è§†å›¾

### æ‰©å±•é˜¶æ®µï¼ˆWeek 3+ï¼‰

å¦‚æœå‘ç°æ€§èƒ½ç“¶é¢ˆæˆ–æŸ¥è¯¢å¤æ‚åº¦è¿‡é«˜ï¼Œå†è€ƒè™‘ï¼š

```sql
-- å¯é€‰ï¼šæŠ•èµ„æ ‡çš„ç‹¬ç«‹è¡¨
CREATE TABLE investment_targets (
  id INTEGER PRIMARY KEY,
  report_id TEXT REFERENCES reports(report_id),
  target_name TEXT,
  target_type TEXT,
  action TEXT,  -- 'recommended' | 'cautious'
  reason TEXT,
  key_metrics TEXT
);
```

---

## ğŸ“ æ•°æ®æ’å…¥ç¤ºä¾‹

```python
import json
import sqlite3

# è¯»å–åŸå§‹æ–‡ä»¶
with open('Aè‚¡4000æ‹‰é”¯è¦ä¸è¦ä¹°é»„é‡‘.txt', 'r') as f:
    content = f.read()

# è¯»å– JSON åˆ†æ
with open('analysis_Aè‚¡ä¸é»„é‡‘ç»¼åˆç­–ç•¥.json', 'r') as f:
    analysis = json.load(f)

# æ’å…¥æ•°æ®åº“
conn = sqlite3.connect('finance.db')
cursor = conn.cursor()

cursor.execute('''
INSERT INTO reports (
  report_id,
  title,
  category,
  date_published,
  content,
  summary_one_sentence,
  sentiment,
  importance_score,
  urgency_score,
  reliability_score,
  action,
  target_allocation,
  analysis_json
) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
''', (
  'analysis_Aè‚¡ä¸é»„é‡‘ç»¼åˆç­–ç•¥_20251127_105237',
  analysis['report_info']['title'],
  analysis['report_info']['category'],
  analysis['report_info']['date'],
  content,
  analysis['summary']['one_sentence'],
  analysis['summary']['sentiment'],
  analysis['key_metrics']['importance_score'],
  analysis['key_metrics']['urgency_score'],
  analysis['key_metrics']['reliability_score'],
  analysis['investment_advice']['action'],
  analysis['investment_advice']['target_allocation'],
  json.dumps(analysis, ensure_ascii=False)
))

conn.commit()
```

---

## âœ… Phase 2.0 è¯„å®¡é€šè¿‡æ ‡å‡†

- [x] è¡¨ç»“æ„æ¸…æ™°åˆç†
- [x] æ”¯æŒå…¨æ–‡æœç´¢
- [x] æ”¯æŒç»“æ„åŒ–æŸ¥è¯¢
- [x] ç´¢å¼•ç­–ç•¥å®Œæ•´
- [x] å…¼å®¹ Email Agent æ¶æ„
- [x] åŸºäºå®é™…æ•°æ®éªŒè¯
- [x] æä¾›ç¤ºä¾‹æŸ¥è¯¢å’Œæ’å…¥ä»£ç 

**è¯„å®¡ç»“è®º**ï¼šâœ… **æ•°æ®åº“è®¾è®¡å·²å®Œæˆï¼Œå¯ä»¥å¼€å§‹ Phase 2.1ï¼ˆSession ç±»å®ç°ï¼‰**

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- [`schema.sql`](schema.sql) - å®Œæ•´çš„è¡¨ç»“æ„å®šä¹‰
- [`sample_data.sql`](sample_data.sql) - ç¤ºä¾‹æ•°æ®å’ŒæŸ¥è¯¢
- [`ER_DIAGRAM.md`](ER_DIAGRAM.md) - è¯¦ç»†çš„è®¾è®¡æ–‡æ¡£
